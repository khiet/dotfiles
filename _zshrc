# https://github.com/robbyrussell/oh-my-zsh/blob/master/templates/zshrc.zsh-template
export ZSH=$HOME/.oh-my-zsh

CASE_SENSITIVE="true"
DISABLE_UPDATE_PROMPT="true"

# https://github.com/robbyrussell/oh-my-zsh/issues/3466
HIST_STAMPS="%d/%m/%y %T "
alias hs='fc -il 1'
# https://www.soberkoder.com/better-zsh-history/
export HISTFILESIZE=20000 # history size during a session
export HISTSIZE=20000 # history size at start of a session
export SAVEHIST=20000 # history size in a file
# export HISTFILE=~/.zsh_history
setopt HIST_FIND_NO_DUPS
setopt INC_APPEND_HISTORY

# standard plugins can be found in ~/.oh-my-zsh/plugins/*
plugins=(
  colored-man-pages
  urltools
  zsh-syntax-highlighting
)

ZSH_DISABLE_COMPFIX="true"
source $ZSH/oh-my-zsh.sh

# based on https://github.com/ohmyzsh/ohmyzsh/blob/master/themes/robbyrussell.zsh-theme
PROMPT="%(?:%{$fg_bold[green]%}➜ :%{$fg_bold[red]%}➜ )"
PROMPT+='%{$fg[cyan]%}%c%{$reset_color%} $(git_prompt_info)'

ZSH_THEME_GIT_PROMPT_PREFIX="%{$fg[magenta]%}\uE0A0 "
ZSH_THEME_GIT_PROMPT_SUFFIX="%{$reset_color%} "
ZSH_THEME_GIT_PROMPT_DIRTY="%{$fg[blue]%} %{$fg[yellow]%}✗"
ZSH_THEME_GIT_PROMPT_CLEAN="%{$fg[blue]%}"

export XDG_DATA_HOME=$HOME/.local/share
export XDG_CONFIG_HOME=$HOME/.config
export XDG_CACHE_HOME=$HOME/.cache

export RIPGREP_CONFIG_PATH=$HOME/.ripgreprc

# vim mode
bindkey -v
export KEYTIMEOUT=1
# https://github.com/robbyrussell/oh-my-zsh/blob/master/plugins/vi-mode/vi-mode.plugin.zsh
bindkey -M vicmd 'v' edit-command-line
bindkey '^h' backward-delete-char

export LESS=-RFX

alias ct='ctags -R .'
alias caly='cal -y'
alias public_ip='curl ipinfo.io/ip'
alias private_ip='ipconfig getifaddr en0'

# tmux
alias ta='tmux attach -t'
alias tls='tmux ls'

# ripgrep
alias g="rg"
alias G="rg --no-ignore"
alias gc="rg -C 3"
alias gw="rg -w"
function gf { rg --files --sort path | rg --regexp $1 }
function gF { rg --files --no-ignore --sort path | rg --regexp $1 }

# rails
alias be="bundle exec"
alias rr="bin/rails restart"
alias rc="bin/rails console"
alias rG="bin/rails generate"
alias rl="tail -f -n 1000 log/development.log"
alias rlc="tail -f -n 1000 log/development.log | rg -A 6 Controller"
alias rlt="tail -f -n 1000 log/test.log"
alias rltc="tail -f -n 1000 log/test.log | rg -A 6 Controller"

if type bat > /dev/null 2>&1; then
  alias cat='bat'
fi

export EDITOR='vim'

# nvim
if type nvim > /dev/null 2>&1; then
  alias vi='nvim'
  alias vim=''
  export EDITOR='nvim'
fi

# fzf
if type "fzf" > /dev/null 2>&1; then
  # copied from ~/fzf.zsh generated by $(brew --prefix)/opt/fzf/install (see brew info fzf)
  # auto-completion
  [[ $- == *i* ]] && source "/usr/local/opt/fzf/shell/completion.zsh" 2> /dev/null
  # key bindings
  source "/usr/local/opt/fzf/shell/key-bindings.zsh"

  # --multi to select multiple files with TAB
  export FZF_DEFAULT_OPTS='--no-mouse --height 50% --reverse --multi --info=inline'
  export FZF_DEFAULT_COMMAND='rg --files --hidden'
fi

if [ -f ~/Dropbox/Apps/tmuxinator/tmuxinator.zsh ]; then
  source ~/Dropbox/Apps/tmuxinator/tmuxinator.zsh
  export TMUXINATOR_CONFIG=~/Dropbox/Apps/tmuxinator
fi

# colorls
alias l='colorls --group-directories-first'
alias ll='colorls --group-directories-first --long'
alias la='colorls --group-directories-first --almost-all'
alias lal='colorls --group-directories-first --almost-all --long'

# rbenv
if type "rbenv" > /dev/null 2>&1; then
  eval "$(rbenv init -)"
fi

# find and replace with rg
function gR  { rg -0 -l "$1" | AGR_FROM="$1" AGR_TO="$2" xargs -0 perl -pi -e 's/$ENV{AGR_FROM}/$ENV{AGR_TO}/g' }
# https://stackoverflow.com/a/48280659
function gfR { rg --files | rg --regexp "$1" | AGR_FROM="$1" AGR_TO="$2" perl -p -e 'print $_; s/$ENV{AGR_FROM}/$ENV{AGR_TO}/' | xargs -n2 mv }
function gfD { rg --files | rg --regexp "$1" | xargs rm }

function mv2 { dirname "$2" | xargs mkdir -p; mv "$1" "$2" }
function cp2 { dirname "$2" | xargs mkdir -p; cp "$1" "$2" }
# list brew dependencies
function brewls { brew list | while read cask; do echo -n $fg[blue] $cask $fg[white]; brew deps $cask | awk '{printf(" %s ", $0)}'; echo ""; done }

function rhs { LC_CTYPE=C sed -i '' -e "s/$1//i" ~/.zsh_history }

function kebab { echo  "$1" | sed 's/ /-/g' | tr "[:upper:]" "[:lower:]" | tr -d ",:" }

# git
alias gdel="git branch --merged | egrep -v '(^\*|master)' | xargs git branch -d"
function gbr { git co -b $(kebab "$1") }

# youtube-dl
function dl {
  if [[ $1 && $2 ]]; then
    youtube-dl -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best' -o "~/youtube/$2" "$1.%(ext)s"
  elif [[ $1 ]]; then
    youtube-dl -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best' -o '~/youtube/%(title)s-%(id)s.%(ext)s' $1
  fi
}

function open {
  if [[ -d $1 ]]; then
    open $1
  else
    open -R $1
  fi
}

# suppress ruby 2.7 warnnings
export RUBYOPT='-W0'
